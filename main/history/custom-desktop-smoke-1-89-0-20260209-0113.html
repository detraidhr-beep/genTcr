<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Custom Desktop Smoke</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 4px; }
    .case {
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin: 12px 0;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .case h3 { margin: 0 0 8px; font-size: 16px; }
    .meta { color: #6b7280; font-size: 0.9em; margin-top: 6px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; }
    ol { margin: 6px 0 0 20px; }
    input[type='checkbox'] { width: 16px; height: 16px; vertical-align: text-top; }
    .case-actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; align-items: flex-start; }
    .case-actions .notes-block { width: 100%; }
    .case-actions .copy-actions { width: 100%; display: flex; gap: 8px; flex-wrap: wrap; }
    .block-head { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .case-actions label { font-size: 0.9em; color: #374151; }
    .case-actions input[type='file'] { font-size: 0.9em; }
    .copy-btn { padding: 6px 10px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f8fafc; cursor: pointer; font-size: 0.85em; transition: transform 0.12s ease, box-shadow 0.12s ease; }
    .copy-btn.copied { box-shadow: 0 0 0 2px rgba(34,197,94,0.25); transform: translateY(-1px); }
    .copy-status { font-size: 0.8em; color: #16a34a; opacity: 0; transition: opacity 0.2s ease; }
    .copy-status.show { opacity: 1; }
    .bug-link-input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .case-notes { width: 100%; min-height: 64px; padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .case-status { min-width: 160px; padding: 6px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 999px; margin: 0 6px; background: #9ca3af; }
    .status-pass .status-indicator { background: #16a34a; }
    .status-fail .status-indicator { background: #dc2626; }
    .status-blocked .status-indicator { background: #f59e0b; }
    .status-skipped .status-indicator { background: #6b7280; }
    .bug-link { display: none; }
    .case-proof { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .case-proof img { max-width: 220px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .toolbar { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0 20px; }
    .toolbar button { padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f8fafc; cursor: pointer; }
    .meta-block { padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #ffffff; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .meta-grid label { display: block; font-size: 0.85em; color: #6b7280; margin-bottom: 4px; }
    .meta-grid input, .meta-grid select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .env-copy { margin-top: 10px; display: flex; gap: 8px; align-items: center; }
    .activity-log { margin-top: 10px; }
    .activity-log ul { padding-left: 18px; }
    .status-chart { margin-top: 18px; padding: 14px 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #ffffff; }
    .status-bars { display: grid; gap: 10px; }
    .status-row { display: grid; grid-template-columns: 100px 1fr 40px; align-items: center; gap: 10px; }
    .status-label { font-size: 0.9em; color: #6b7280; }
    .status-bar { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .status-bar span { display: block; height: 100%; border-radius: 999px; }
    .status-bar .pass { background: #16a34a; }
    .status-bar .fail { background: #dc2626; }
    .status-bar .blocked { background: #f59e0b; }
    .status-bar .skipped { background: #6b7280; }
    .status-bar .not_set { background: #9ca3af; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b0f14; color: #e5e7eb; }
      .case { background: #111827; border-color: #1f2937; box-shadow: none; }
      pre { background: #0f172a; }
      .meta { color: #9ca3af; }
      .case-actions label { color: #9ca3af; }
      .case-notes { background: #0f172a; color: #e5e7eb; border-color: #1f2937; }
      .case-status { background: #0f172a; color: #e5e7eb; border-color: #1f2937; }
      .case-proof img { border-color: #1f2937; }
      .toolbar button { background: #111827; color: #e5e7eb; border-color: #1f2937; }
      .copy-btn { background: #111827; color: #e5e7eb; border-color: #1f2937; }
      .bug-link-input { background: #0f172a; color: #e5e7eb; border-color: #1f2937; }
      .meta-block { background: #111827; border-color: #1f2937; }
      .meta-grid input, .meta-grid select { background: #0f172a; color: #e5e7eb; border-color: #1f2937; }
      .copy-btn.copied { box-shadow: 0 0 0 2px rgba(34,197,94,0.25); }
      .status-chart { background: #111827; border-color: #1f2937; }
      .status-bar { background: #1f2937; }
      .bug-link { background: #2a1a12; color: #fbbf24; border-color: #1f2937; }
    }
  </style>
</head>
<body>
  <h1>Custom Desktop Smoke</h1>
  <div class="meta"><strong>Run ID:</strong> 20260209T011315Z</div>
  <div class="meta-block">
    <h2>Environment</h2>
    <div class="meta-grid">
      <div>
        <label>Template</label>
        <select id="env-template" data-templates="[{&quot;name&quot;: &quot;Desktop macOS&quot;, &quot;platform&quot;: &quot;Desktop&quot;, &quot;os_version&quot;: &quot;macOS 14.5&quot;, &quot;app_version&quot;: &quot;&quot;, &quot;build&quot;: &quot;&quot;}, {&quot;name&quot;: &quot;Desktop Linux&quot;, &quot;platform&quot;: &quot;Desktop&quot;, &quot;os_version&quot;: &quot;Debian 13&quot;, &quot;app_version&quot;: &quot;&quot;, &quot;build&quot;: &quot;&quot;}, {&quot;name&quot;: &quot;Desktop Windows&quot;, &quot;platform&quot;: &quot;Desktop&quot;, &quot;os_version&quot;: &quot;Windows 11&quot;, &quot;app_version&quot;: &quot;&quot;, &quot;build&quot;: &quot;&quot;}, {&quot;name&quot;: &quot;Mobile iOS&quot;, &quot;platform&quot;: &quot;Mobile&quot;, &quot;os_version&quot;: &quot;iOS 26.1&quot;, &quot;app_version&quot;: &quot;&quot;, &quot;build&quot;: &quot;&quot;}, {&quot;name&quot;: &quot;Mobile Android&quot;, &quot;platform&quot;: &quot;Mobile&quot;, &quot;os_version&quot;: &quot;Android 13&quot;, &quot;app_version&quot;: &quot;&quot;, &quot;build&quot;: &quot;&quot;}]">
          <option value="">Select template</option>
          <option value="Desktop macOS">Desktop macOS</option>
          <option value="Desktop Linux">Desktop Linux</option>
          <option value="Desktop Windows">Desktop Windows</option>
          <option value="Mobile iOS">Mobile iOS</option>
          <option value="Mobile Android">Mobile Android</option>
        </select>
      </div>
    </div>
    <div class="meta-grid">
      <div>
        <label>Collector</label>
        <input id="collector" type="text" value="QA Engineer" />
      </div>
      <div>
        <label>Collector email</label>
        <input id="collector-email" type="email" value="qa@example.com" />
      </div>
      <div>
        <label>Platform</label>
        <input id="env-platform" type="text" value="Desktop" />
      </div>
      <div>
        <label>OS version</label>
        <input id="env-os" type="text" value="macOS 14.5" />
      </div>
      <div>
        <label>App version</label>
        <input id="env-version" type="text" value="1.89.0" />
      </div>
      <div>
        <label>Build</label>
        <input id="env-build" type="text" value="123.45" />
      </div>
    </div>
    <div class="env-copy">
      <button class="copy-btn" data-copy="environment">Copy environment</button>
      <span class="copy-status"></span>
    </div>
  </div>
  <h2>Description</h2>
  <pre>Custom checklist for smoke verification.

Use this when validating a new build before the full QA pass.</pre>
  <div class="toolbar">
    <button id="export-json">Export report JSON</button>
    <button id="export-html">Export HTML snapshot</button>
    <button id="save-final">Save final HTML</button>
    <button id="export-log">Export activity log</button>
  </div>
  <h2>Checklist</h2>
  <div class="case" data-case-key="CUST-1" data-case-title="Launch browser">
    <h3><input type="checkbox" class="case-check" /> Launch browser (CUST-1)</h3>
    <div class="block-head"><strong>Steps:</strong>
      <button class="copy-btn" data-copy="steps">Copy</button>
      <span class="copy-status"></span></div>
    <ol>
      <li>Install the build</li>
      <li>Launch the app</li>
    </ol>
    <div class="meta"><strong>Expected:</strong> Browser starts without crashes</div>
    <div class="meta"><strong>Tags:</strong> smoke, desktop</div>
    <div class="case-actions">
      <label>Status</label>
      <select class="case-status">
        <option value="not_set">Not set</option>
        <option value="pass">Pass</option>
        <option value="fail">Fail</option>
        <option value="blocked">Blocked</option>
        <option value="skipped">Skipped</option>
      </select>
      <span class="status-indicator"></span>
      <div class="block-head">
        <label>Bug link</label>
        <button class="copy-btn" data-copy="bug">Copy</button>
        <span class="copy-status"></span></div>
      <input class="bug-link-input" type="url" placeholder="Paste bug link (your repo)..." />
      <div class="notes-block">
        <div class="block-head"><label>Notes</label>
          <button class="copy-btn" data-copy="notes">Copy</button>
          <span class="copy-status"></span></div>
        <textarea class="case-notes" placeholder="Notes or evidence..."></textarea>
      </div>
      <div class="block-head">
        <label>Proof (screenshots)</label>
        <button class="copy-btn" data-copy="attachments">Copy</button>
        <span class="copy-status"></span></div>
      <input class="case-file" type="file" accept="image/*" multiple />
      <div class="block-head">
        <label>Summary</label>
        <button class="copy-btn" data-copy="summary">Copy</button>
        <span class="copy-status"></span></div>
    </div>
    <div class="case-proof"></div>
  </div>
  <div class="case" data-case-key="CUST-2" data-case-title="Open new tab">
    <h3><input type="checkbox" class="case-check" /> Open new tab (CUST-2)</h3>
    <div class="block-head"><strong>Steps:</strong>
      <button class="copy-btn" data-copy="steps">Copy</button>
      <span class="copy-status"></span></div>
    <ol>
      <li>Open a new tab</li>
      <li>Navigate to brave.com</li>
    </ol>
    <div class="meta"><strong>Expected:</strong> Page loads without errors</div>
    <div class="meta"><strong>Tags:</strong> smoke</div>
    <div class="meta"><strong>Links:</strong> <a href="https://brave.com" target="_blank" rel="noreferrer">https://brave.com</a></div>
    <div class="case-actions">
      <label>Status</label>
      <select class="case-status">
        <option value="not_set">Not set</option>
        <option value="pass">Pass</option>
        <option value="fail">Fail</option>
        <option value="blocked">Blocked</option>
        <option value="skipped">Skipped</option>
      </select>
      <span class="status-indicator"></span>
      <div class="block-head">
        <label>Bug link</label>
        <button class="copy-btn" data-copy="bug">Copy</button>
        <span class="copy-status"></span></div>
      <input class="bug-link-input" type="url" placeholder="Paste bug link (your repo)..." />
      <div class="notes-block">
        <div class="block-head"><label>Notes</label>
          <button class="copy-btn" data-copy="notes">Copy</button>
          <span class="copy-status"></span></div>
        <textarea class="case-notes" placeholder="Notes or evidence..."></textarea>
      </div>
      <div class="block-head">
        <label>Proof (screenshots)</label>
        <button class="copy-btn" data-copy="attachments">Copy</button>
        <span class="copy-status"></span></div>
      <input class="case-file" type="file" accept="image/*" multiple />
      <div class="block-head">
        <label>Summary</label>
        <button class="copy-btn" data-copy="summary">Copy</button>
        <span class="copy-status"></span></div>
    </div>
    <div class="case-proof"></div>
  </div>
  <div class="case" data-case-key="CUST-3" data-case-title="Open new tab">
    <h3><input type="checkbox" class="case-check" /> Open new tab (CUST-3)</h3>
    <div class="block-head"><strong>Steps:</strong>
      <button class="copy-btn" data-copy="steps">Copy</button>
      <span class="copy-status"></span></div>
    <ol>
      <li>Open a new tab</li>
      <li>Navigate to brave.com</li>
    </ol>
    <div class="meta"><strong>Expected:</strong> Page loads without errors</div>
    <div class="meta"><strong>Tags:</strong> smoke</div>
    <div class="meta"><strong>Links:</strong> <a href="https://brave.com" target="_blank" rel="noreferrer">https://brave.com</a></div>
    <div class="case-actions">
      <label>Status</label>
      <select class="case-status">
        <option value="not_set">Not set</option>
        <option value="pass">Pass</option>
        <option value="fail">Fail</option>
        <option value="blocked">Blocked</option>
        <option value="skipped">Skipped</option>
      </select>
      <span class="status-indicator"></span>
      <div class="block-head">
        <label>Bug link</label>
        <button class="copy-btn" data-copy="bug">Copy</button>
        <span class="copy-status"></span></div>
      <input class="bug-link-input" type="url" placeholder="Paste bug link (your repo)..." />
      <div class="notes-block">
        <div class="block-head"><label>Notes</label>
          <button class="copy-btn" data-copy="notes">Copy</button>
          <span class="copy-status"></span></div>
        <textarea class="case-notes" placeholder="Notes or evidence..."></textarea>
      </div>
      <div class="block-head">
        <label>Proof (screenshots)</label>
        <button class="copy-btn" data-copy="attachments">Copy</button>
        <span class="copy-status"></span></div>
      <input class="case-file" type="file" accept="image/*" multiple />
      <div class="block-head">
        <label>Summary</label>
        <button class="copy-btn" data-copy="summary">Copy</button>
        <span class="copy-status"></span></div>
    </div>
    <div class="case-proof"></div>
  </div>
  <div class="activity-log">
    <h2>Activity log</h2>
    <ul id="activity-list"></ul>
  </div>
  <div class="status-chart">
    <h2>Status summary</h2>
    <div class="status-bars" id="status-bars"></div>
  </div>
  <script>
    const runId = '20260209T011315Z';
    const baseFileName = 'custom-desktop-smoke-1-89-0-20260209-0113';
    const storageKey = 'customChecklist:' + document.title + ':' + runId;
    const state = JSON.parse(localStorage.getItem(storageKey) || '{}');
    const saveState = () => localStorage.setItem(storageKey, JSON.stringify(state));
    const slugify = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || 'checklist';
    state.meta = state.meta || {};
    state.meta.environment = state.meta.environment || {};
    state.logs = state.logs || [];
    const activityList = document.getElementById('activity-list');
    const renderLogs = () => {
      activityList.innerHTML = '';
      state.logs.forEach((entry) => {
        const li = document.createElement('li');
        li.textContent = `[${entry.at}] ${entry.action}`;
        activityList.appendChild(li);
      });
    };
    const renderStatusChart = () => {
      const summary = { pass: 0, fail: 0, blocked: 0, skipped: 0, not_set: 0 };
      document.querySelectorAll('.case').forEach((card) => {
        const status = card.querySelector('.case-status');
        const value = status ? status.value : 'not_set';
        summary[value] = (summary[value] || 0) + 1;
      });
      const total = Object.values(summary).reduce((a, b) => a + b, 0) || 1;
      const barRoot = document.getElementById('status-bars');
      barRoot.innerHTML = '';
      const order = [
        ['pass', 'Pass'],
        ['fail', 'Fail'],
        ['blocked', 'Blocked'],
        ['skipped', 'Skipped'],
        ['not_set', 'Not set'],
      ];
      order.forEach(([key, label]) => {
        const count = summary[key] || 0;
        const row = document.createElement('div');
        row.className = 'status-row';
        row.innerHTML = `
          <div class="status-label">${label}</div>
          <div class="status-bar"><span class="${key}" style="width:${(count / total) * 100}%"></span></div>
          <div class="status-label">${count}</div>
        `;
        barRoot.appendChild(row);
      });
    };
    const logEvent = (action) => {
      state.logs.push({ at: new Date().toISOString(), action });
      saveState();
      renderLogs();
    };
    const bindMetaInput = (id, key, label) => {
      const input = document.getElementById(id);
      if (!input) return;
      if (state.meta.environment[key]) {
        input.value = state.meta.environment[key];
      } else if (input.value) {
        state.meta.environment[key] = input.value;
      }
      input.addEventListener('input', () => {
        state.meta.environment[key] = input.value;
        saveState();
      });
      input.addEventListener('change', () => {
        logEvent(`${label} set to ${input.value}`);
      });
    };
    const collectorInput = document.getElementById('collector');
    const collectorEmailInput = document.getElementById('collector-email');
    if (collectorInput) {
      if (state.meta.collector) collectorInput.value = state.meta.collector;
      collectorInput.addEventListener('input', () => {
        state.meta.collector = collectorInput.value;
        saveState();
      });
      collectorInput.addEventListener('change', () => {
        logEvent(`Collector set to ${collectorInput.value}`);
      });
    }
    const envCopyBtn = document.querySelector('.env-copy .copy-btn');
    if (envCopyBtn) {
      const envStatus = document.querySelector('.env-copy .copy-status');
      envCopyBtn.addEventListener('click', () => {
        const envText = [
          `Platform: ${document.getElementById('env-platform').value || ''}`,
          `OS version: ${document.getElementById('env-os').value || ''}`,
          `App version: ${document.getElementById('env-version').value || ''}`,
          `Build: ${document.getElementById('env-build').value || ''}`,
        ].join('\n');
        copyText(envText, envCopyBtn, envStatus);
      });
    }
    if (collectorEmailInput) {
      if (state.meta.collectorEmail) collectorEmailInput.value = state.meta.collectorEmail;
      collectorEmailInput.addEventListener('input', () => {
        state.meta.collectorEmail = collectorEmailInput.value;
        saveState();
      });
      collectorEmailInput.addEventListener('change', () => {
        logEvent(`Collector email set to ${collectorEmailInput.value}`);
      });
    }
    bindMetaInput('env-platform', 'platform', 'Platform');
    bindMetaInput('env-os', 'os_version', 'OS version');
    bindMetaInput('env-version', 'app_version', 'App version');
    bindMetaInput('env-build', 'build', 'Build');
    const templateSelect = document.getElementById('env-template');
    if (templateSelect) {
      const templates = JSON.parse(templateSelect.dataset.templates || '[]');
      templateSelect.addEventListener('change', () => {
        const selected = templates.find((t) => t.name === templateSelect.value);
        if (!selected) return;
        document.getElementById('env-platform').value = selected.platform || '';
        document.getElementById('env-os').value = selected.os_version || '';
        document.getElementById('env-version').value = selected.app_version || '';
        document.getElementById('env-build').value = selected.build || '';
        state.meta.environment = {
          platform: selected.platform || '',
          os_version: selected.os_version || '',
          app_version: selected.app_version || '',
          build: selected.build || '',
        };
        saveState();
        logEvent(`Template applied: ${selected.name}`);
      });
    }
    document.querySelectorAll('.case').forEach((card) => {
      const key = card.getAttribute('data-case-key');
      const checkbox = card.querySelector('.case-check');
      const notes = card.querySelector('.case-notes');
      const status = card.querySelector('.case-status');
      const indicator = card.querySelector('.status-indicator');
      const fileInput = card.querySelector('.case-file');
      const proof = card.querySelector('.case-proof');
      const bugInput = card.querySelector('.bug-link-input');
      const copyButtons = card.querySelectorAll('.copy-btn');
      const saved = state[key] || {};
      checkbox.checked = !!saved.checked;
      notes.value = saved.notes || '';
      status.value = saved.status || 'not_set';
      const setStatusClass = (value) => {
        card.classList.remove('status-pass', 'status-fail', 'status-blocked', 'status-skipped');
        if (value && value !== 'not_set') {
          card.classList.add(`status-${value}`);
        }
        if (indicator) {
          indicator.setAttribute('data-status', value || 'not_set');
        }
      };
      setStatusClass(status.value);
      if (bugInput) {
        bugInput.value = saved.bug_link || '';
      }
      checkbox.addEventListener('change', () => {
        state[key] = state[key] || {};
        state[key].checked = checkbox.checked;
        saveState();
        logEvent(`Case ${key} checkbox set to ${checkbox.checked}`);
      });
      status.addEventListener('change', () => {
        state[key] = state[key] || {};
        state[key].status = status.value;
        saveState();
        logEvent(`Case ${key} status set to ${status.value}`);
        setStatusClass(status.value);
        renderStatusChart();
      });
      if (bugInput) {
        bugInput.addEventListener('input', () => {
          state[key] = state[key] || {};
          state[key].bug_link = bugInput.value.trim();
          saveState();
        });
        bugInput.addEventListener('change', () => {
          if (bugInput.value) {
            logEvent(`Case ${key} bug link set to ${bugInput.value}`);
          }
        });
      }
      notes.addEventListener('input', () => {
        state[key] = state[key] || {};
        state[key].notes = notes.value;
        saveState();
      });
      notes.addEventListener('change', () => {
        logEvent(`Case ${key} notes updated`);
      });
      fileInput.addEventListener('change', () => {
        const files = Array.from(fileInput.files || []);
        if (!files.length) return;
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = () => {
            const dataUrl = reader.result;
            const img = document.createElement('img');
            img.src = dataUrl;
            img.dataset.name = file.name;
            proof.appendChild(img);
            saveState();
            logEvent(`Case ${key} added screenshot ${file.name}`);
          };
          reader.readAsDataURL(file);
        });
        fileInput.value = '';
      });
      const collectSteps = () => {
        const items = Array.from(card.querySelectorAll('ol li')).map((li) => li.textContent.trim());
        if (!items.length) return '';
        return items.map((step, idx) => `${idx + 1}. ${step}`).join('\n');
      };
      const collectNotes = () => notes ? notes.value.trim() : '';
      const collectBugLink = () => bugInput ? bugInput.value.trim() : '';
      const collectAttachments = () => {
        const images = Array.from(card.querySelectorAll('.case-proof img'));
        if (!images.length) return '';
        return images.map((img, idx) => {
          const name = img.dataset.name || `screenshot-${idx + 1}`;
          return `${name}: ${img.src}`;
        }).join('\n');
      };
      const collectSummary = () => {
        const title = card.getAttribute('data-case-title') || key;
        const statusValue = status ? status.value : 'not_set';
        const parts = [
          `Title: ${title}`,
          `Status: ${statusValue}`,
        ];
        const bugLink = collectBugLink();
        if (bugLink) parts.push(`Bug: ${bugLink}`);
        const steps = collectSteps();
        if (steps) parts.push('Steps:\n' + steps);
        const notesText = collectNotes();
        if (notesText) parts.push('Notes:\n' + notesText);
        const attachments = collectAttachments();
        if (attachments) parts.push('Attachments:\n' + attachments);
        return parts.join('\n\n');
      };
      const copyText = (text, button, statusEl) => {
        if (!text) return;
        const showCopied = () => {
          const status = statusEl || (button ? button.closest('.block-head')?.querySelector('.copy-status') : null);
          if (!status) return;
          status.textContent = 'Copied';
          status.classList.add('show');
          setTimeout(() => {
            status.textContent = '';
            status.classList.remove('show');
          }, 1500);
        };
        if (button) {
          button.classList.add('copied');
          setTimeout(() => button.classList.remove('copied'), 1500);
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(showCopied).catch(showCopied);
          return;
        }
        const area = document.createElement('textarea');
        area.value = text;
        document.body.appendChild(area);
        area.select();
        document.execCommand('copy');
        area.remove();
        showCopied();
      };
      copyButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const kind = btn.getAttribute('data-copy');
          if (kind === 'steps') copyText(collectSteps(), btn);
          if (kind === 'notes') copyText(collectNotes(), btn);
          if (kind === 'attachments') copyText(collectAttachments(), btn);
          if (kind === 'summary') copyText(collectSummary(), btn);
          if (kind === 'bug') copyText(collectBugLink(), btn);
        });
      });
    });
    renderLogs();
    renderStatusChart();
    const buildReport = () => {
      const cases = [];
      document.querySelectorAll('.case').forEach((card) => {
        const key = card.getAttribute('data-case-key');
        const title = card.getAttribute('data-case-title');
        const checkbox = card.querySelector('.case-check');
        const notes = card.querySelector('.case-notes');
        const status = card.querySelector('.case-status');
        const images = Array.from(card.querySelectorAll('.case-proof img')).map((img) => img.src);
        const bugLink = bugInput ? bugInput.value.trim() : '';
        cases.push({
          key,
          title,
          checked: checkbox.checked,
          status: status.value,
          notes: notes.value,
          bug_link: bugLink,
          images,
        });
      });
      return {
        title: document.title,
        generatedAt: new Date().toISOString(),
        collector: state.meta.collector || document.getElementById('collector').value || '',
        collector_email: state.meta.collectorEmail || document.getElementById('collector-email').value || '',
        environment: {
          platform: document.getElementById('env-platform').value || '',
          os_version: document.getElementById('env-os').value || '',
          app_version: document.getElementById('env-version').value || '',
          build: document.getElementById('env-build').value || '',
        },
        logs: state.logs || [],
        cases,
      };
    };
    const downloadFile = (filename, content, type) => {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    };
    const exportHtml = (filename) => {
      const clone = document.documentElement.cloneNode(true);
      clone.querySelectorAll('.case').forEach((card) => {
        const checkbox = card.querySelector('.case-check');
        const notes = card.querySelector('.case-notes');
        const status = card.querySelector('.case-status');
        const bugInput = card.querySelector('.bug-link-input');
        if (checkbox && checkbox.checked) {
          checkbox.setAttribute('checked', 'checked');
        } else if (checkbox) {
          checkbox.removeAttribute('checked');
        }
        if (notes) {
          notes.textContent = notes.value;
        }
        if (status) {
          status.querySelectorAll('option').forEach((opt) => {
            if (opt.value === status.value) {
              opt.setAttribute('selected', 'selected');
            } else {
              opt.removeAttribute('selected');
            }
          });
        }
        if (bugInput) {
          bugInput.setAttribute('value', bugInput.value);
        }
      });
      clone.querySelectorAll('input').forEach((input) => {
        if (input.type === 'checkbox') return;
        input.setAttribute('value', input.value);
      });
      clone.querySelectorAll('textarea').forEach((area) => {
        area.textContent = area.value;
      });
      clone.querySelectorAll('script').forEach((script) => script.remove());
      const htmlContent = '<!doctype html>\n' + clone.outerHTML;
      downloadFile(filename, htmlContent, 'text/html');
    };
    document.getElementById('export-json').addEventListener('click', () => {
      const report = buildReport();
      const filename = `${slugify(report.title)}-report.json`;
      downloadFile(filename, JSON.stringify(report, null, 2), 'application/json');
    });
    document.getElementById('export-log').addEventListener('click', () => {
      const report = buildReport();
      const filename = `${slugify(report.title)}-activity-log.json`;
      downloadFile(filename, JSON.stringify(report.logs || [], null, 2), 'application/json');
    });
    document.getElementById('export-html').addEventListener('click', () => {
      const filename = `${slugify(document.title)}-snapshot.html`;
      exportHtml(filename);
    });
    document.getElementById('save-final').addEventListener('click', () => {
      const filename = `${baseFileName}-final.html`;
      exportHtml(filename);
    });
  </script>
</body>
</html>
